# 需給スコア算出ロジック V2.1

## 概要

需給分析スコアは、**4つのカテゴリー（A~D）** に分類された **11の指標** を評価し、**重み付け合算** することで算出されます。

## スコアリング構造

```
Raw Score = (A × 1.0) + (B × 2.0) + (C × 1.5) + (D × 1.0)
Scaled Score (0-100) = ((Raw Score - (-18)) / (19.5 - (-18))) × 100
```

- **理論的最大値**: +19.5点
- **理論的最小値**: -18.0点
- **最終スコア**: 0～100にスケーリング

---

## カテゴリー別詳細

### **A. 需給・流動性 (Weight: 1.0)**

#### 1. 信用倍率 (Z-Score)
**指標**: 過去26週の信用倍率の標準偏差からの乖離

| 条件 | ポイント | 説明 |
|------|---------|------|
| Z ≤ -1.5 | **+3** | 信用倍率が大幅に解消（強気） |
| Z ≤ -0.5 | **+1** | 信用倍率が好転傾向 |
| Z ≥ +1.5 | **-2** | 信用倍率が過熱（調整リスク） |
| その他 | **0** | 中立 |

#### 2. 信用回転日数
**指標**: `信用買残 / 日次出来高`

| 条件 | ポイント | 説明 |
|------|---------|------|
| < 5日 | **+1** | 短期需給良好 |
| > 20日 | **-1** | 需給停滞 |
| その他 | **0** | 標準 |

#### 3. 回転率（出来高/時価総額）
**指標**: `(日次出来高 × 株価) / 時価総額 × 100`

| 条件 | ポイント | 説明 |
|------|---------|------|
| > 5% | **+2** | 活発な売買 |
| > 2% | **+1** | 良好な流動性 |
| < 0.2% | **-1** | 流動性不足 |
| その他 | **0** | 普通 |

**カテゴリーA 最大**: +6点  
**カテゴリーA 最小**: -4点

---

### **B. セクター (Weight: 2.0)**

#### 4. 業種別資金流入比率
**指標**: `Business Sector Trading Value (直近5日平均) / (過去60日平均)`

| 条件 | ポイント | 説明 |
|------|---------|------|
| ≥ 1.2 | **+2** | 業種に資金流入中 |
| < 0.8 | **-2** | 業種から資金流出中 |
| その他 | **0** | 中立 |

#### 5. 業種騰落率
**指標**: 業種全体の5日間リターン

| 条件 | ポイント | 説明 |
|------|---------|------|
| > 5% | **+1** | 業種が好調 |
| その他 | **0** | 中立 |

**カテゴリーB 小計**: -2 ～ +3点  
**重み付け後**: -4 ～ +6点 **(x2.0)**

---

### **C. テクニカル (Weight: 1.5)**

#### 6. 個別資金流入比率
**指標**: `個別銘柄Trading Value (直近5日平均) / (過去60日平均)`

| 条件 | ポイント | 説明 |
|------|---------|------|
| ≥ 1.5 | **+2** | 資金急増 |
| ≥ 1.1 かつ 連続3日以上 | **+2** | 継続的な資金流入 |
| ≥ 1.1 | **+1** | 資金流入傾向 |
| その他 | **0** | 中立 |

#### 7. VWAP乖離率
**指標**: `(終値 - VWAP) / VWAP × 100`

| 条件 | ポイント | 説明 |
|------|---------|------|
| > +1% | **+2** | VWAP上抜け（強気） |
| > 0% | **+1** | VWAPサポート |
| < -1% | **-2** | VWAP下抜け（弱気） |
| その他 | **0** | 中立 |

#### 8. 移動平均線乖離率
**指標**: `(終値 - MA5) / MA5 × 100`

| 条件 | ポイント | 説明 |
|------|---------|------|
| > +20% | **-2** | 過熱（調整リスク） |
| > 0% | **+1** | 上昇トレンド |
| その他 | **0** | 中立 |

#### 9. 個別パフォーマンス（5日間リターン）
**指標**: 直近5日間の騰落率

| 条件 | ポイント | 説明 |
|------|---------|------|
| > +10% | **+1** | 強い上昇 |
| < -10% | **-1** | 大幅下落 |
| その他 | **0** | 標準 |

**カテゴリーC 小計**: -5 ～ +6点  
**重み付け後**: -7.5 ～ +9点 **(x1.5)**

---

### **D. 市場フィルター (Weight: 1.0)**

#### 10. 騰落レシオ（Prime市場25日移動平均）
**指標**: `(騰落レシオ) / 100` (Prime市場限定)

| 条件 | ポイント | 説明 |
|------|---------|------|
| 80% ≤ R < 105% | **+1.5** | 健全な地合い |
| 105% ≤ R < 120% | **+1** | やや過熱気味 |
| R ≥ 120% | **0** | 過熱（警戒） |
| R < 80% | **0** | 軟調 |

#### 11. 市場トレンド判定
**備考**: 騰落レシオと連動して、最終的な市場地合いを判定

**カテゴリーD 最大**: +1.5点

---

## 最終スコア計算例

### 例1: 強気シグナル

```
[A] 需給・流動性 (x1.0)
  信用倍率:解消(Z≦-1.5) (+3)
  回転日数<5日 (+1)
  回転率>5% (+2)
  → 小計: +6点

[B] セクター (x2.0)
  業種別資金流入 (+2)
  業種騰落率:好調 (+1)
  → 小計: +3点 → 重み付け後: +6点

[C] テクニカル (x1.5)
  個別資金急増 (+2)
  VWAP乖離:上抜け (+2)
  MA上昇トレンド (+1)
  → 小計: +5点 → 重み付け後: +7.5点

[D] 市場フィルター (x1.0)
  騰落レシオ:健全 (+1.5)

Raw Score = 6 + 6 + 7.5 + 1.5 = 21点 (理論値超過のため19.5にキャップ)
Scaled Score = ((19.5 - (-18)) / 37.5) × 100 = 100
```

### 例2: 弱気シグナル

```
[A] 需給・流動性
  信用倍率:過熱(Z≧1.5) (-2)
  回転率<0.2% (-1)
  → 小計: -3点

[B] セクター
  業種別資金流出 (-2)
  → 小計: -2点 → 重み付け後: -4点

[C] テクニカル
  VWAP乖離:下抜け (-2)
  MA乖離過熱 (-2)
  → 小計: -4点 → 重み付け後: -6点

[D] 市場フィルター
  騰落レシオ:軟調 (0)

Raw Score = -3 + (-4) + (-6) + 0 = -13点
Scaled Score = ((-13 - (-18)) / 37.5) × 100 = 13.3 → 13点
```

---

## 指標の計算方法詳細

### 信用倍率 Z-Score
```python
# 過去26週の信用倍率データから計算
mean = margin_ratio_26w.mean()
std = margin_ratio_26w.std()
z_score = (latest_ratio - mean) / std
```

### VWAP (Volume Weighted Average Price)
```python
# 注意: DBのtrading_valueは千円単位
vwap = (trading_value * 1000) / volume
vwap_deviation = ((close - vwap) / vwap) * 100
```

### 回転率
```python
turnover_rate = (volume * close) / market_cap * 100
```

---

## カテゴリー重み付けの理由

| カテゴリー | 重み | 理由 |
|----------|------|------|
| **A. 需給・流動性** | 1.0 | 基礎的な需給バランスを評価 |
| **B. セクター** | **2.0** | 業種全体の資金フローが個別銘柄に最も影響 |
| **C. テクニカル** | **1.5** | 個別の売買動向とモメンタムを重視 |
| **D. 市場フィルター** | 1.0 | 全体相場の地合いを確認 |

---

## 変更履歴

### V2.1 (現行)
- 信用倍率をZ-Scoreベースに変更（絶対値→相対評価）
- カテゴリー重み付けシステム導入
- 理論的最大値: 19.5点、最小値: -18.0点

### V2.0
- 11指標体系確立
- セクター分析強化

---

## 補足: スコア表示形式

PDFレポートでは以下のように表示：
- **スケーリングスコア (0-100)**: ゲージチャートで視覚化
- **生スコア (Raw Score)**: 計算過程の詳細リスト
- **カテゴリー別小計**: A/B/C/Dの内訳

---

## コード実装場所

- **ファイル**: `src/analysis/supply_demand.py`
- **関数**: `SupplyDemandAnalyzer.calculate_score_v2_1()`
- **行番号**: 923-1134

---

**作成日**: 2025-12-20  
**バージョン**: V2.1
