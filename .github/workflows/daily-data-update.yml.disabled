name: Daily Stock Data Update

# 毎日午後5時（日本時間）に自動実行
# GitHub Actionsは UTC で動作するため、8時（UTC）= 17時（JST）
on:
  schedule:
    - cron: '0 8 * * *'  # 毎日8:00 UTC = 17:00 JST
  workflow_dispatch:  # 手動実行も可能

jobs:
  update-stock-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download latest database
      uses: actions/download-artifact@v4
      with:
        name: stock-database
        path: data/
      continue-on-error: true  # 初回実行時はアーティファクトが存在しない
    
    - name: Create database if not exists
      run: |
        if [ ! -f data/stock_data.db ]; then
          echo "データベースが存在しないため、新規作成します"
          python src/core/db_manager.py
        fi
    
    - name: Run batch data update
      env:
        KABU_PLUS_USER: ${{ secrets.KABU_PLUS_USER }}
        KABU_PLUS_PASSWORD: ${{ secrets.KABU_PLUS_PASSWORD }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        PYTHONPATH: ${{ github.workspace }}
      run: |
        echo "=== バッチ処理開始 ==="
        python src/core/batch_loader.py
        echo "=== バッチ処理完了 ==="
    
    - name: Verify database update
      run: |
        echo "=== データベース統計 ==="
        sqlite3 data/stock_data.db "SELECT '企業数: ' || COUNT(*) FROM companies;"
        sqlite3 data/stock_data.db "SELECT '最新データ: ' || MAX(date) FROM daily_prices;"
        sqlite3 data/stock_data.db "SELECT 'データ期間: ' || COUNT(DISTINCT date) || '日分' FROM daily_prices;"
    
    - name: Upload updated database
      uses: actions/upload-artifact@v4
      with:
        name: stock-database
        path: data/stock_data.db
        retention-days: 90  # 90日間保持
